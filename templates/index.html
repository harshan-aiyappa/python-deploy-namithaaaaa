<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Learning Reports Dashboard</title>
    <script>
      tailwind.config = {
        // Use dark mode manually by applying dark classes everywhere for this example
        // darkMode: 'class', // Or 'media' if you prefer OS setting
        theme: {
          extend: {
            colors: {
              // Define a new purple/violet primary theme
              primary: {
                50: "#f5f3ff",
                100: "#ede9fe",
                200: "#ddd6fe",
                300: "#c4b5fd",
                400: "#a78bfa", // Lighter purple for accents/text
                500: "#8b5cf6", // Main purple
                600: "#7c3aed", // Slightly darker main purple (good for buttons)
                700: "#6d28d9", // Darker purple (good for headers/hover)
                800: "#5b21b6",
                900: "#4c1d95",
                950: "#2e1065", // Very dark purple
              },
              // Define dark theme grays
              gray: {
                50: "#f9fafb",
                100: "#f3f4f6",
                200: "#e5e7eb",
                300: "#d1d5db",
                400: "#9ca3af",
                500: "#6b7280",
                600: "#4b5563", // Medium-dark gray
                700: "#374151", // Dark gray (cards, inputs)
                800: "#1f2937", // Darker gray (sidebar, sections)
                900: "#111827", // Base background
                950: "#030712", // Very dark gray
              },
            },
            typography: ({ theme }) => ({
              // Add Tailwind Typography config
              invert: {
                // Define styles for prose-invert (dark mode)
                css: {
                  "--tw-prose-body": theme("colors.gray[300]"),
                  "--tw-prose-headings": theme("colors.gray[100]"),
                  "--tw-prose-lead": theme("colors.gray[400]"),
                  "--tw-prose-links": theme("colors.primary[400]"),
                  "--tw-prose-bold": theme("colors.gray[100]"),
                  "--tw-prose-counters": theme("colors.gray[400]"),
                  "--tw-prose-bullets": theme("colors.gray[600]"),
                  "--tw-prose-hr": theme("colors.gray[700]"),
                  "--tw-prose-quotes": theme("colors.gray[100]"),
                  "--tw-prose-quote-borders": theme("colors.gray[700]"),
                  "--tw-prose-captions": theme("colors.gray[400]"),
                  "--tw-prose-code": theme("colors.gray[100]"),
                  "--tw-prose-pre-code": theme("colors.gray[300]"),
                  "--tw-prose-pre-bg": theme("colors.gray[800]"),
                  "--tw-prose-th-borders": theme("colors.gray[600]"),
                  "--tw-prose-td-borders": theme("colors.gray[700]"),
                  // Customize further if needed
                },
              },
            }),
            animation: {
              "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
            },
            // Add ring offset color for dark backgrounds
            ringOffsetColor: {
              DEFAULT: "#111827", // Match bg-gray-900
            },
          },
        },
        plugins: [
          // Add the typography plugin
          require("@tailwindcss/typography"),
        ],
      };
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <!-- Load typography plugin -->
    <style>
      /* Style scrollbars for webkit browsers (Chrome, Safari) */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1f2937; /* gray-800 */
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: #4b5563; /* gray-600 */
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #6b7280; /* gray-500 */
      }
      /* Basic scrollbar styling for Firefox */
      body {
        scrollbar-color: #4b5563 #1f2937; /* thumb track */
        scrollbar-width: thin;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-300 font-sans antialiased">
    <div class="min-h-screen flex flex-col">
      <!-- Header -->
      <header
        class="bg-primary-700 text-white py-4 px-6 shadow-lg border-b border-primary-800 sticky top-0 z-10"
      >
        <div class="container mx-auto flex items-center justify-between">
          <h1 class="text-2xl font-bold flex items-center">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-8 w-8 mr-3 text-primary-300"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"
              />
            </svg>
            Learning Reports Dashboard
          </h1>
          <div class="flex items-center space-x-4">
            <span
              id="statusBadge"
              class="hidden px-3 py-1 text-white text-sm font-medium rounded-full shadow-sm"
            >
              Loading...
            </span>
          </div>
        </div>
      </header>

      <div class="flex flex-1">
        <!-- Sidebar -->
        <aside
          class="w-full md:w-1/4 lg:w-1/5 bg-gray-800 shadow-lg transition-all duration-300 ease-in-out border-r border-gray-700 md:sticky md:top-[73px]"
          id="sidebar"
        >
          <!-- Adjusted max-height for dark theme header -->
          <div class="overflow-y-auto" style="max-height: calc(100vh - 73px)">
            <div class="p-4 space-y-6">
              <!-- Search Section -->
              <div class="pt-2">
                <h2
                  class="text-lg font-semibold mb-3 flex items-center text-gray-100"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 mr-2 text-primary-400"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                      clip-rule="evenodd"
                    />
                  </svg>
                  Search & Ask AI
                </h2>
                <div class="space-y-3">
                  <div class="relative">
                    <input
                      type="text"
                      id="searchBox"
                      placeholder="Search FAQs or ask the AI..."
                      class="w-full py-2 pl-10 pr-10 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm bg-gray-700 text-gray-200 placeholder-gray-400"
                    />
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    <button
                      id="clearSearch"
                      class="absolute right-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-500 hidden hover:text-gray-300 transition-colors"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                          clip-rule="evenodd"
                        />
                      </svg>
                    </button>
                  </div>
                  <div class="flex items-center">
                    <button
                      onclick="sendCustomQuestion()"
                      class="bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition duration-150 ease-in-out text-sm w-full flex items-center justify-center font-medium shadow-md"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 mr-2"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M3 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm5 0a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1H9a1 1 0 01-1-1V4zm5 4a1 1 0 011-1h2a1 1 0 011 1v8a1 1 0 01-1 1h-2a1 1 0 01-1-1V8z"
                          clip-rule="evenodd"
                        />
                      </svg>
                      Ask AI Assistant
                    </button>
                  </div>
                  <div
                    id="searchStatus"
                    class="text-sm text-gray-400 mt-1 hidden text-center"
                  ></div>
                </div>
              </div>

              <!-- Question List -->
              <div class="pt-2">
                <h2
                  class="text-lg font-semibold mb-3 flex items-center text-gray-100"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 mr-2 text-primary-400"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"
                      clip-rule="evenodd"
                    />
                  </svg>
                  Frequently Asked Questions
                </h2>
                <div id="questionListContainer" class="space-y-3 mt-2">
                  <!-- Skeleton Loader -->
                  <div class="animate-pulse-slow">
                    <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-gray-700 rounded w-1/2 mb-2"></div>
                    <div class="h-4 bg-gray-700 rounded w-2/3"></div>
                  </div>
                  <div class="animate-pulse-slow opacity-75">
                    <div class="h-4 bg-gray-700 rounded w-5/6 mb-2"></div>
                    <div class="h-4 bg-gray-700 rounded w-3/4"></div>
                  </div>
                </div>
                <ul id="questionList" class="space-y-2 mt-2 hidden">
                  <!-- Dynamic questions -->
                </ul>
              </div>
            </div>
          </div>
        </aside>

        <!-- Main Content -->
        <main
          class="w-full md:w-3/4 lg:w-4/5 p-6 md:p-8 bg-gray-900 overflow-y-auto flex-1"
        >
          <div class="container mx-auto">
            <!-- Toggle sidebar button (mobile only) -->
            <button
              id="toggleSidebar"
              class="md:hidden mb-4 flex items-center text-gray-400 hover:text-gray-200 transition-colors"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 mr-2"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
              Toggle Menu
            </button>

            <!-- Welcome message -->
            <div
              id="welcomeMessage"
              class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6 border border-gray-700"
            >
              <h2 class="text-2xl font-bold mb-4 text-primary-400">
                Student Learning Reports Insights
              </h2>
              <p class="text-gray-400 mb-5">
                Analyze student data, visualize trends, and generate insights
                using pre-defined questions or by asking our AI assistant
                directly.
              </p>
              <div class="flex flex-wrap gap-2 mb-5">
                <span
                  class="bg-primary-900 text-primary-300 text-xs font-medium px-3 py-1 rounded-full"
                  >Data Analysis</span
                >
                <span
                  class="bg-green-900 text-green-300 text-xs font-medium px-3 py-1 rounded-full"
                  >Visualization</span
                >
                <span
                  class="bg-purple-900 text-purple-300 text-xs font-medium px-3 py-1 rounded-full"
                  >AI-Powered Q&A</span
                >
              </div>
              <div class="p-4 bg-gray-700 rounded-lg border border-gray-600">
                <h3 class="font-semibold text-gray-200 mb-2">
                  Getting Started:
                </h3>
                <ol
                  class="list-decimal list-inside text-gray-400 space-y-2 text-sm"
                >
                  <li>Select a question from the FAQ list on the left.</li>
                  <li>
                    If the question needs specifics (like class or grade),
                    you'll be prompted to select them.
                  </li>
                  <li>
                    View the generated analysis summary and visualization.
                  </li>
                  <li>
                    Alternatively, type your own question into the search box
                    and click "Ask AI Assistant".
                  </li>
                </ol>
              </div>
            </div>

            <!-- Parameter Selection Container -->
            <div
              id="paramContainer"
              class="hidden bg-gray-800 p-6 rounded-lg shadow-lg mb-6 border border-gray-700"
            >
              <!-- Dynamically populated -->
            </div>

            <!-- ** NEW: Retry Popup ** -->
            <div
              id="retry-popup"
              class="hidden bg-gray-800 border-2 border-dashed border-yellow-500 p-6 rounded-lg shadow-lg mb-6 text-center"
            >
              <img
                src="https://img.icons8.com/plasticine/100/000000/bot.png"
                alt="Friendly robot suggesting to try again"
                class="mx-auto mb-4 w-24 h-24"
              />
              <!-- Replace 'https://img.icons8.com/plasticine/100/000000/bot.png' with your preferred cartoon image URL -->
              <p id="popup-text-message" class="text-yellow-300 mb-4">
                Oops! Something went wrong. Maybe try asking differently?
              </p>
              <button
                onclick="closePopupAndReset()"
                class="bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition duration-150 ease-in-out text-sm font-medium shadow-md"
              >
                Got it!
              </button>
              Optional: Add a real retry button if you store last query
              <button
                onclick="retryLastQuery()"
                class="ml-2 bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition duration-150 ease-in-out text-sm font-medium shadow-md"
              >
                Try Again
              </button>
            </div>

            <!-- Results Container -->
            <div
              id="resultsContainer"
              class="bg-gray-800 rounded-lg shadow-lg mb-6 border border-gray-700 hidden"
            >
              <div class="border-b border-gray-700">
                <div
                  class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-5 sm:p-6 gap-3"
                >
                  <h2 class="text-xl font-bold text-gray-100 flex items-center">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-6 w-6 mr-2 text-primary-400 flex-shrink-0"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2H9V9z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    Analysis Results
                  </h2>
                  <div class="flex space-x-2 flex-shrink-0">
                    <button
                      id="downloadReportBtn"
                      disabled
                      class="flex items-center text-sm text-primary-400 border border-primary-600 px-3 py-1.5 rounded-md hover:bg-primary-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 mr-1.5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                          clip-rule="evenodd"
                        />
                      </svg>
                      Download
                    </button>
                    <button
                      id="shareReportBtn"
                      class="flex items-center text-sm text-primary-400 border border-primary-600 px-3 py-1.5 rounded-md hover:bg-primary-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-all"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 mr-1.5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                      >
                        <path
                          d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"
                        />
                      </svg>
                      Share
                    </button>
                  </div>
                </div>
              </div>
              <!-- Result Content Area -->
              <div class="p-6 flex flex-col gap-6">
                <!-- Visualization Section (Will be shown only if there's a visualization) -->
                <div id="visualizationSection" class="w-full hidden">
                  <h3
                    class="text-lg font-semibold text-gray-100 mb-3 border-b border-gray-700 pb-2"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-5 inline-block mr-1.5 -mt-0.5 text-primary-400"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M3 3a1 1 0 000 2v8a1 1 0 001 1h1.586l.707.707a1 1 0 001.414 0L7.414 14H10a1 1 0 100-2H7.414l-.707-.707A1 1 0 006 11H4V5h2a1 1 0 000-2H3zm11 1a1 1 0 00-1 1v2a1 1 0 001 1h2a1 1 0 001-1V5a1 1 0 00-1-1h-2zm-1 5a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1V10a1 1 0 00-1-1h-2z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    Visualization
                  </h3>
                <div class="bg-gray-700 rounded-lg p-4 border border-gray-600 min-h-[200px] flex items-center justify-center w-full">
    <!-- Image for analysis (hidden by default) -->
    <img id="analysisImage"
         class="w-full h-[300px] sm:h-[400px] md:h-[500px] lg:h-[600px] object-contain rounded-md"
         style="display: none;">

    <!-- Fallback message when no analysis is available (hidden by default) -->
    <div id="noAnalysis"
         class="text-center p-6 text-gray-500 flex flex-col items-center justify-center w-full h-full"
         style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg"
             class="h-12 w-12 text-gray-600 mb-3"
             fill="none"
             viewBox="0 0 24 24"
             stroke="currentColor">
            <path stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <p id="noAnalysisText">No analysis generated yet.</p>
    </div>
</div>



                </div>

                <!-- Summary Section -->
                <div id="summarySection" class="w-full">
                  <h3
                    class="text-lg font-semibold text-gray-100 mb-3 border-b border-gray-700 pb-2"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-5 inline-block mr-1.5 -mt-0.5 text-primary-400"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    Summary
                  </h3>
                  <div
                    id="summaryTextContainer"
                    class="bg-gray-700 p-4 rounded-md border border-gray-600"
                  >
                    <p
                      id="summaryText"
                      class="text-gray-300 prose prose-sm prose-invert max-w-none"
                    ></p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Error Messages -->
            <div
              id="errorContainer"
              class="hidden bg-red-900 bg-opacity-50 border-l-4 border-red-500 p-4 rounded-md mb-6 shadow-md"
            >
              <div class="flex">
                <div class="flex-shrink-0">
                  <svg
                    class="h-5 w-5 text-red-400"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
                <div class="ml-3">
                  <h3 id="errorTitle" class="text-sm font-medium text-red-300">
                    An error occurred
                  </h3>
                  <div class="mt-2 text-sm text-red-400">
                    <p id="errorMessage"></p>
                  </div>
                </div>
                <div class="ml-auto pl-3">
                  <div class="-mx-1.5 -my-1.5">
                    <button
                      type="button"
                      onclick="hideError()"
                      class="inline-flex bg-red-900 rounded-md p-1.5 text-red-400 hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-red-900 focus:ring-red-600"
                    >
                      <span class="sr-only">Dismiss</span>
                      <svg
                        class="h-5 w-5"
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                        aria-hidden="true"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                          clip-rule="evenodd"
                        />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Success Messages -->
            <div
              id="successContainer"
              class="hidden bg-green-900 bg-opacity-50 border-l-4 border-green-500 p-4 rounded-md mb-6 shadow-md"
            >
              <div class="flex">
                <div class="flex-shrink-0">
                  <svg
                    class="h-5 w-5 text-green-400"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
                <div class="ml-3">
                  <h3 class="text-sm font-medium text-green-300">Success</h3>
                  <div class="mt-2 text-sm text-green-400">
                    <p id="successMessage"></p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Loading Indicator -->
            <div
              id="loadingIndicator"
              class="hidden bg-gray-800 p-6 rounded-lg shadow-lg mb-6 text-center border border-gray-700"
            >
              <div
                class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500 mb-4"
              ></div>
              <p id="loadingMessage" class="text-gray-400">
                Processing your request...
              </p>
            </div>
          </div>
        </main>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-800 py-4 px-6 border-t border-gray-700 mt-auto">
        <div class="container mx-auto text-center text-gray-500 text-sm">
          Â© 2025 Learning Reports Dashboard |
          <span class="text-primary-400"
            >Data-driven insights for better learning outcomes</span
          >
        </div>
      </footer>
    </div>

    <script>
      // ========================================================
      // JAVASCRIPT FUNCTIONALITY (UPDATED FOR NEW BACKEND)
      // ========================================================
      let BASE_URL; // Declare globally
      let lastUserQuery = { type: null, data: null }; // Store last query for potential retry

      // --- UI Element References ---
      const uiElements = {
        statusBadge: () => document.getElementById("statusBadge"),
        sidebar: () => document.getElementById("sidebar"),
        searchBox: () => document.getElementById("searchBox"),
        clearSearch: () => document.getElementById("clearSearch"),
        searchStatus: () => document.getElementById("searchStatus"),
        questionListContainer: () =>
          document.getElementById("questionListContainer"),
        questionList: () => document.getElementById("questionList"),
        toggleSidebar: () => document.getElementById("toggleSidebar"),
        welcomeMessage: () => document.getElementById("welcomeMessage"),
        paramContainer: () => document.getElementById("paramContainer"),
        resultsContainer: () => document.getElementById("resultsContainer"),
        summarySection: () => document.getElementById("summarySection"),
        summaryTextContainer: () =>
          document.getElementById("summaryTextContainer"),
        summaryText: () => document.getElementById("summaryText"),
        visualizationSection: () =>
          document.getElementById("visualizationSection"),
        analysisImage: () => document.getElementById("analysisImage"),
        noAnalysis: () => document.getElementById("noAnalysis"),
        noAnalysisText: () => document.getElementById("noAnalysisText"),
        downloadReportBtn: () => document.getElementById("downloadReportBtn"),
        shareReportBtn: () => document.getElementById("shareReportBtn"),
        errorContainer: () => document.getElementById("errorContainer"),
        errorMessage: () => document.getElementById("errorMessage"),
        errorTitle: () => document.getElementById("errorTitle"),
        successContainer: () => document.getElementById("successContainer"),
        successMessage: () => document.getElementById("successMessage"),
        loadingIndicator: () => document.getElementById("loadingIndicator"),
        loadingMessage: () => document.getElementById("loadingMessage"),
        retryPopup: () => document.getElementById("retry-popup"),
        popupTextMessage: () => document.getElementById("popup-text-message"),
      };

      // Function to fetch BASE_URL from backend
      async function loadBaseUrl() {
        try {
          const configResponse = await fetch("/config");
          if (!configResponse.ok) {
            const rootConfigResponse = await fetch(
              window.location.origin + "/config"
            );
            if (!rootConfigResponse.ok)
              throw new Error(
                `Config fetch failed: ${configResponse.status} & ${rootConfigResponse.status}`
              );
            const config = await rootConfigResponse.json();
            BASE_URL = config.base_url || window.location.origin;
          } else {
            const config = await configResponse.json();
            BASE_URL = config.base_url || window.location.origin;
          }
          console.log("BASE_URL loaded:", BASE_URL);
        } catch (error) {
          console.error("Error fetching BASE_URL:", error);
          BASE_URL = window.location.origin;
          console.warn("Using fallback BASE_URL:", BASE_URL);
          showError(
            "Could not load server configuration. Using default settings."
          );
        }
      }

      let selectedQuestion = "";

      // --- Utility Functions (UI State Management) ---
      function showError(message, title = "An error occurred") {
        const errorContainer = uiElements.errorContainer();
        if (!errorContainer) return;
        uiElements.errorMessage().textContent = message;
        uiElements.errorTitle().textContent = title;
        errorContainer.classList.remove("hidden");
        errorContainer.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      function hideError() {
        uiElements.errorContainer()?.classList.add("hidden");
      }

      function showSuccess(message) {
        const successContainer = uiElements.successContainer();
        if (!successContainer) return;
        uiElements.successMessage().textContent = message;
        successContainer.classList.remove("hidden");
        successContainer.scrollIntoView({
          behavior: "smooth",
          block: "center",
        });
        setTimeout(hideSuccess, 4000); // Auto-hide
      }

      function hideSuccess() {
        uiElements.successContainer()?.classList.add("hidden");
      }

      function showLoading(message = "Processing...") {
        hideAllMainContent(); // Hide welcome, results, params, popup
        hideError();
        hideSuccess();
        const loadingIndicator = uiElements.loadingIndicator();
        if (!loadingIndicator) return;
        uiElements.loadingMessage().textContent = message;
        loadingIndicator.classList.remove("hidden");
        loadingIndicator.scrollIntoView({
          behavior: "smooth",
          block: "center",
        });
      }

      function hideLoading() {
        uiElements.loadingIndicator()?.classList.add("hidden");
      }

      function showWelcome() {
        hideAllMainContent();
        uiElements.welcomeMessage()?.classList.remove("hidden");
      }

      function showRetryPopup(message) {
        hideAllMainContent();
        const popup = uiElements.retryPopup();
        if (!popup) return;
        uiElements.popupTextMessage().textContent =
          message ||
          "Oops! Something went wrong. Please try rephrasing or try again.";
        popup.classList.remove("hidden");
        popup.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      function hideRetryPopup() {
        uiElements.retryPopup()?.classList.add("hidden");
      }

      function closePopupAndReset() {
        hideRetryPopup();
        resetUI(); // Reset to welcome or default state
      }

      function hideParamContainer() {
        uiElements.paramContainer()?.classList.add("hidden");
      }

      // Hides all major content blocks in the main area
      function hideAllMainContent() {
        uiElements.welcomeMessage()?.classList.add("hidden");
        uiElements.resultsContainer()?.classList.add("hidden");
        uiElements.paramContainer()?.classList.add("hidden");
        uiElements.retryPopup()?.classList.add("hidden");
        // Don't hide loading/error/success here, they are managed separately
      }

      function resetUI() {
        hideAllMainContent();
        hideLoading();
        hideError();
        hideSuccess();
        showWelcome(); // Show the welcome message by default
        selectedQuestion = "";
        // Reset selected item style in question list
        document
          .querySelectorAll("#questionList li ul li div")
          .forEach((item) => {
            item.classList.remove(
              "bg-primary-600",
              "text-white",
              "font-semibold"
            );
            item.classList.add("hover:bg-gray-700");
          });
        // Reset download button
        const downloadBtn = uiElements.downloadReportBtn();
        if (downloadBtn) {
          downloadBtn.disabled = true;
          downloadBtn.classList.add("opacity-50", "cursor-not-allowed");
        }
      }

      // --- Event Listeners Setup ---
      document.addEventListener("DOMContentLoaded", async () => {
        await loadBaseUrl();

        const statusBadge = uiElements.statusBadge();
        if (statusBadge) statusBadge.classList.remove("hidden");

        uiElements.toggleSidebar()?.addEventListener("click", () => {
          uiElements.sidebar()?.classList.toggle("hidden");
        });

        const searchBox = uiElements.searchBox();
        const clearButton = uiElements.clearSearch();
        if (searchBox && clearButton) {
          searchBox.addEventListener("input", () => {
            const hasValue = !!searchBox.value;
            clearButton.classList.toggle("hidden", !hasValue);
            clearButton.classList.toggle("inline-flex", hasValue);
            handleSearch(searchBox.value.trim().toLowerCase());
          });
          clearButton.addEventListener("click", () => {
            searchBox.value = "";
            searchBox.dispatchEvent(new Event("input"));
            searchBox.focus();
          });
          searchBox.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
              event.preventDefault();
              sendCustomQuestion();
            }
          });
        }

        uiElements.downloadReportBtn()?.addEventListener("click", () => {
          const img = uiElements.analysisImage();
          if (
            img &&
            img.src &&
            !img.closest(".hidden") &&
            img.src.startsWith("data:image/png;base64,")
          ) {
            const link = document.createElement("a");
            link.href = img.src;
            const filename = selectedQuestion
              ? `analysis_${selectedQuestion.replace(/[^a-z0-9]/gi, "_")}.png`
              : `analysis_result_${Date.now()}.png`;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showSuccess("Image download started.");
          } else {
            showError("No valid analysis image available to download.");
          }
        });

        uiElements.shareReportBtn()?.addEventListener("click", () => {
          const shareData = {
            title: "Learning Report Analysis",
            text: "Check out this analysis from the Learning Reports Dashboard!",
            url: window.location.href,
          };
          if (navigator.share && navigator.canShare(shareData)) {
            navigator.share(shareData).catch((error) => {
              console.log("Error sharing:", error);
              copyLinkFallback();
            });
          } else {
            copyLinkFallback();
          }
        });

        await loadQuestions(); // Load questions after setting up listeners
      });

      function copyLinkFallback() {
        navigator.clipboard
          .writeText(window.location.href)
          .then(() => {
            showSuccess("Link copied to clipboard!");
          })
          .catch((err) => {
            console.error("Could not copy text: ", err);
            showError("Failed to copy link. Manually copy the URL.");
          });
      }

      // --- Load Questions ---
      async function loadQuestions() {
        const statusBadge = uiElements.statusBadge();
        const qListContainer = uiElements.questionListContainer();
        const qList = uiElements.questionList();

        try {
          qListContainer?.classList.remove("hidden"); // Show skeleton
          qList?.classList.add("hidden"); // Hide list
          if (statusBadge) {
            statusBadge.textContent = "Loading...";
            statusBadge.className =
              "px-3 py-1 bg-yellow-500 text-white text-sm font-medium rounded-full shadow-sm"; // Explicitly set class
          }

          if (!BASE_URL) {
            throw new Error("Configuration error: BASE_URL not set.");
          }

          console.log(`Fetching questions from ${BASE_URL}/questions`);
          const response = await fetch(`${BASE_URL}/questions`);
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(
              `Failed to fetch questions: ${response.status} - ${errorText}`
            );
          }

          const questions = await response.json();
          console.log(`Questions loaded:`, questions);

          if (!qList) return; // Exit if list element not found
          qList.innerHTML = ""; // Clear

          if (Object.keys(questions).length === 0) {
            qList.innerHTML = `<li class="p-3 text-gray-500 text-sm">No FAQs found. Try asking the AI.</li>`;
            if (statusBadge) {
              statusBadge.textContent = "No FAQs";
              statusBadge.className =
                "px-3 py-1 bg-orange-500 text-white text-sm font-medium rounded-full shadow-sm";
            }
          } else {
            // ... (rest of the question rendering logic - no functional changes needed here)
            for (const categoryKey in questions) {
              const categoryData = questions[categoryKey];
              const categoryItem = document.createElement("li");
              categoryItem.className =
                "bg-gray-800 rounded-md shadow-sm overflow-hidden border border-gray-700";

              const categoryHeader = document.createElement("div");
              categoryHeader.className =
                "flex items-center justify-between p-3 cursor-pointer bg-gray-700 border-b border-gray-600 hover:bg-gray-600 transition-colors";
              categoryHeader.innerHTML = `
                        <span class="font-semibold text-gray-100 text-sm">${categoryData.category}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 category-chevron transition-transform transform rotate-0" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    `;

              const subList = document.createElement("ul");
              subList.className = "hidden border-t border-gray-700"; // Start collapsed

              categoryData.questions.forEach((question) => {
                const li = document.createElement("li");
                li.className = "border-b border-gray-700 last:border-b-0";
                li.innerHTML = `
                            <div class="cursor-pointer p-3 hover:bg-gray-700 transition-colors text-sm text-gray-300 flex items-center justify-between group">
                                <span class="flex-1 pr-2">${question.text}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 group-hover:text-primary-400 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        `;
                li.dataset.questionKey = question.key;
                li.onclick = () => {
                  document
                    .querySelectorAll("#questionList li ul li div")
                    .forEach((item) => {
                      item.classList.remove(
                        "bg-primary-600",
                        "text-white",
                        "font-semibold"
                      );
                      item.classList.add("hover:bg-gray-700");
                    });
                  const divElement = li.querySelector("div");
                  divElement.classList.add(
                    "bg-primary-600",
                    "text-white",
                    "font-semibold"
                  );
                  divElement.classList.remove("hover:bg-gray-700");

                  selectedQuestion = question.key;
                  lastUserQuery = {
                    type: "faq",
                    data: { key: question.key, text: question.text },
                  }; // Store for potential retry
                  processQuestion(); // Process immediately
                  resetQuestionDisplay();
                };
                subList.appendChild(li);
              });

              categoryHeader.onclick = () => {
                const chevron =
                  categoryHeader.querySelector(".category-chevron");
                const isOpening = subList.classList.contains("hidden");
                chevron.classList.toggle("rotate-180", isOpening);
                subList.classList.toggle("hidden");
              };

              categoryItem.appendChild(categoryHeader);
              categoryItem.appendChild(subList);
              qList.appendChild(categoryItem);
            }
            if (statusBadge) {
              statusBadge.textContent = "Ready";
              statusBadge.className =
                "px-3 py-1 bg-green-500 text-white text-sm font-medium rounded-full shadow-sm";
            }
          }

          qListContainer?.classList.add("hidden"); // Hide skeleton
          qList?.classList.remove("hidden"); // Show list
          statusBadge?.classList.remove("hidden");
        } catch (error) {
          console.error("Error loading questions:", error);
          showError(`Failed to load FAQs: ${error.message}.`);
          qListContainer?.classList.add("hidden");
          qList?.classList.remove("hidden"); // Show error message in list area
          if (qList)
            qList.innerHTML = `<li class="p-3 text-red-400 text-sm">Error loading questions.</li>`;
          if (statusBadge) {
            statusBadge.textContent = "Error";
            statusBadge.className =
              "px-3 py-1 bg-red-500 text-white text-sm font-medium rounded-full shadow-sm";
          }
        }
      }

      // --- Search ---
      function handleSearch(query) {
        // ... (Search logic remains mostly the same, ensure highlighting uses dark theme compatible colors)
        // Example highlight class change: `<span class="bg-yellow-400 text-gray-900 px-0.5 rounded">${match}</span>`
        const questionList = uiElements.questionList();
        if (!questionList) return;
        const statusEl = uiElements.searchStatus();

        if (!query) {
          // Reset view: hide highlights, collapse categories unless one is selected
          document
            .querySelectorAll("#questionList > li")
            .forEach((categoryItem) => {
              const categoryList = categoryItem.querySelector("ul");
              if (!categoryList) return;
              const isSelected =
                categoryList.querySelector("div.bg-primary-600") !== null;
              if (!isSelected) {
                categoryList.classList.add("hidden");
                const chevron = categoryItem.querySelector(".category-chevron");
                if (chevron) chevron.classList.remove("rotate-180");
              } else {
                categoryList.classList.remove("hidden");
                const chevron = categoryItem.querySelector(".category-chevron");
                if (chevron) chevron.classList.add("rotate-180");
              }
            });

          document
            .querySelectorAll("#questionList li ul li")
            .forEach((item) => {
              item.style.display = "block";
              const divElement = item.querySelector("div > span");
              if (divElement && item.dataset.originalText) {
                divElement.innerHTML = item.dataset.originalText;
                delete item.dataset.originalText;
              }
              item
                .querySelector("div")
                .classList.remove("bg-yellow-800", "bg-opacity-25"); // Remove highlight bg
            });
          statusEl?.classList.add("hidden");
          return;
        }

        let anyMatchFound = false;
        let matchCount = 0;
        const escapedQuery = query.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&");
        const queryRegex = new RegExp(escapedQuery, "gi");

        document
          .querySelectorAll("#questionList > li")
          .forEach((categoryItem) => {
            const categoryList = categoryItem.querySelector("ul");
            if (!categoryList) return;
            let categoryHasMatches = false;

            categoryList.querySelectorAll("li").forEach((item) => {
              const divElement = item.querySelector("div");
              const spanElement = divElement?.querySelector("span");
              if (!spanElement) return;

              if (!item.dataset.originalText) {
                item.dataset.originalText = spanElement.innerHTML;
              }
              const originalText = item.dataset.originalText;
              const isMatch = originalText.toLowerCase().includes(query);

              if (isMatch) {
                item.style.display = "block";
                categoryHasMatches = true;
                anyMatchFound = true;
                matchCount++;
                // Dark theme compatible highlight:
                spanElement.innerHTML = originalText.replace(
                  queryRegex,
                  (match) =>
                    `<span class="bg-yellow-400 text-gray-900 px-0.5 rounded">${match}</span>`
                );
                divElement.classList.add("bg-yellow-800", "bg-opacity-25");
              } else {
                item.style.display = "none";
                spanElement.innerHTML = originalText;
                divElement.classList.remove("bg-yellow-800", "bg-opacity-25");
              }
            });

            const isSelected =
              categoryList.querySelector("div.bg-primary-600") !== null;
            if (!isSelected) {
              categoryList.classList.toggle("hidden", !categoryHasMatches);
              const chevron = categoryItem.querySelector(".category-chevron");
              if (chevron)
                chevron.classList.toggle("rotate-180", categoryHasMatches);
            } else if (categoryHasMatches) {
              categoryList.classList.remove("hidden");
              const chevron = categoryItem.querySelector(".category-chevron");
              if (chevron) chevron.classList.add("rotate-180");
            }
          });

        if (anyMatchFound) {
          if (statusEl) {
            statusEl.textContent = `Found ${matchCount} matching FAQ${
              matchCount !== 1 ? "s" : ""
            }`;
            statusEl.classList.remove("hidden");
          }
          hideError();
        } else {
          if (statusEl) {
            statusEl.textContent = `No FAQs matching "${query}" found.`;
            statusEl.classList.remove("hidden");
          }
        }
      }

      // --- Parameter Handling ---
      function getParameterMapping(questionKey) {
        // Maintain this mapping
        const specificMappings = {
          "UQ1.1": { column: "Organization_Name", sheetIndex: 0 },
          "UQ1.2": { column: "Organization_Name", sheetIndex: 0 },
          "UQ1.3": { column: "Organization_Name", sheetIndex: 0 },
          "UQ1.4": { column: "Organization_Name", sheetIndex: 0 },
          "UQ1.5": { column: "Organization_Name", sheetIndex: 0 },
          "UQ1.6": { column: "Organization_Name", sheetIndex: 0 },
          "UQ1.7": { column: "Organization_Name", sheetIndex: 0 },
          "UQ1.8": { column: "Organization_Name", sheetIndex: 0 },
          "UQ1.9": { column: "Organization_Name", sheetIndex: 0 },
          "UQ2.1": { column: "Grade", sheetIndex: 0 },
          "UQ2.2": { column: "Grade", sheetIndex: 0 },
          "UQ2.12": { column: "Grade", sheetIndex: 0 },
          // Add more mappings as needed
        };
        return specificMappings[questionKey] || null;
      }

      async function loadParameterOptions(columnName, sheetIndex) {
        try {
          if (!BASE_URL) await loadBaseUrl();
          console.log(
            `Fetching options for column: ${columnName}, sheet: ${sheetIndex}`
          );
          const response = await fetch(`${BASE_URL}/get_parameter_options`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              column_name: columnName,
              sheet_index: sheetIndex,
            }),
          });
          if (!response.ok) throw new Error(`API error: ${response.status}`);
          const result = await response.json(); // Assume backend sends clean JSON
          const validOptions = (result.options || [])
            .filter(
              (option) =>
                option !== null &&
                option !== undefined &&
                String(option).trim() !== ""
            )
            .map(String);
          console.log(`Filtered options for ${columnName}:`, validOptions);
          return validOptions;
        } catch (error) {
          console.error("Error in loadParameterOptions:", error);
          showError(`Failed to load parameter options: ${error.message}`);
          return null;
        }
      }

      async function handleParameterizedQuestion(questionText, questionKey) {
        const mapping = getParameterMapping(questionKey);
        if (!mapping) {
          showError("Internal error: Parameter mapping missing.");
          return;
        }

        showLoading(`Loading options for ${mapping.column}...`);
        let options = await loadParameterOptions(
          mapping.column,
          mapping.sheetIndex
        );
        hideLoading();

        if (options === null) return; // Error already shown
        if (options.length === 0) {
          showError(
            `No parameter options found for '${mapping.column}'. Cannot proceed.`
          );
          resetUI();
          return;
        }

        // Sort options (Grade sorting logic retained)
        if (questionKey.startsWith("UQ2") && mapping.column === "Grade") {
          try {
            options = [
              ...new Set(
                options.map((grade) => {
                  const gradeValue = String(grade).trim().toUpperCase();
                  if (
                    gradeValue === "K" ||
                    gradeValue === "KG" ||
                    gradeValue === "KINDERGARTEN"
                  )
                    return "K";
                  const match = gradeValue.match(/^\d+/);
                  return match ? parseInt(match[0], 10) : null;
                })
              ),
            ]
              .filter((g) => g !== null)
              .sort((a, b) => (a === "K" ? -1 : b === "K" ? 1 : a - b))
              .map(String);
          } catch (e) {
            console.error("Error processing grade options:", e);
            options.sort((a, b) =>
              String(a).localeCompare(String(b), undefined, { numeric: true })
            );
          }
        } else {
          options.sort((a, b) =>
            String(a).localeCompare(String(b), undefined, { numeric: true })
          );
        }

        if (options.length === 0) {
          showError(
            `No valid options after processing for '${mapping.column}'.`
          );
          resetUI();
          return;
        }

        createParameterDropdown(
          options,
          mapping.column,
          questionKey,
          questionText,
          mapping.sheetIndex
        );
      }

      function createParameterDropdown(
        options,
        columnName,
        questionKey,
        questionText,
        sheetIndex
      ) {
        hideAllMainContent(); // Hide other content before showing params
        const container = uiElements.paramContainer();
        if (!container) return;
        container.innerHTML = "";
        container.className =
          "bg-gray-800 p-6 rounded-lg shadow-lg mb-6 border border-gray-700"; // Ensure styles

        container.innerHTML = `
            <h3 class="text-lg font-semibold text-gray-100 mb-4">Configure Analysis: ${questionText}</h3>
            <label for="paramSelect" class="block mb-2 text-sm font-medium text-gray-300">Select ${columnName}:</label>
            <select id="paramSelect" name="paramSelect" class="w-full p-2.5 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm bg-gray-700 text-gray-200 mb-4">
                <option value="" disabled selected>-- Please select an option --</option>
                ${options
                  .map(
                    (option) => `<option value="${option}">${option}</option>`
                  )
                  .join("")}
            </select>
            <button id="runAnalysisBtn" class="bg-primary-600 text-white px-5 py-2.5 rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition duration-150 ease-in-out text-sm font-medium w-full sm:w-auto shadow-md">
                Run Analysis
            </button>
        `;

        container.querySelector("#runAnalysisBtn").onclick = () => {
          const selectedValue = container.querySelector("#paramSelect").value;
          if (!selectedValue) {
            showError("Please select an option.");
            return;
          }
          hideError();
          const params = { [columnName]: selectedValue };
          lastUserQuery = {
            type: "faq_param",
            data: { key: questionKey, params: params, sheetIndex: sheetIndex },
          }; // Store for retry
          processQuestionWithParams(questionKey, params, sheetIndex);
          container.classList.add("hidden"); // Hide after clicking run
        };

        container.classList.remove("hidden");
        container.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      // --- Core Processing Functions ---

      // Generic function to handle fetch and common UI updates
      async function handleFetch(url, options, loadingMessage) {
        showLoading(loadingMessage);
        hideAllMainContent(); // Hide previous content before fetch

        try {
          if (!BASE_URL) await loadBaseUrl(); // Ensure BASE_URL is loaded
          const response = await fetch(`${BASE_URL}${url}`, options);

          if (!response.ok) {
            let errorDetail = `Request failed with status ${response.status}.`;
            try {
              const errorJson = await response.json();
              // Look for specific error fields from the backend response
              errorDetail =
                errorJson.error ||
                errorJson.detail ||
                JSON.stringify(errorJson);
            } catch (e) {
              // If response is not JSON, use text
              errorDetail = (await response.text()) || errorDetail;
            }
            // Use the specific error detail in the Error object
            throw new Error(errorDetail);
          }

          const result = await response.json();
          console.log("Backend response:", result);
          hideLoading();

          // ** NEW: Check for UI Hint before displaying results **
          if (result.ui_hint === "SHOW_RETRY_POPUP") {
            showRetryPopup(result.popup_message);
            // Do NOT proceed to displayResults
          } else if (result.error) {
            // Handle backend errors not caught by response.ok (e.g., internal analysis error)
            // Show popup for these backend-originated errors as well
            console.error("Backend reported error:", result.error);
            showRetryPopup(
              `Analysis failed: ${result.error}. Please try rephrasing.`
            );
          } else {
            // Success: Display results normally
            displayResults(result);
          }
        } catch (error) {
          console.error("Error during fetch:", error);
          hideLoading();
          // Show generic error popup for fetch failures or unhandled errors
          showRetryPopup(
            `An error occurred: ${error.message}. Check connection or try again.`
          );
        }
      }

      function processQuestionWithParams(questionKey, params, sheetIndex) {
        handleFetch(
          "/process_question",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              question: questionKey,
              params: params,
              sheet_index: sheetIndex,
            }),
          },
          "Analyzing data with selected parameter..."
        );
      }

      function processQuestion() {
        if (!selectedQuestion) return; // Should not happen

        const questionElement = document.querySelector(
          `[data-question-key="${selectedQuestion}"]`
        );
        const questionText = questionElement
          ? questionElement.querySelector("span").textContent.trim()
          : "Selected Question";
        const mapping = getParameterMapping(selectedQuestion);

        if (mapping && mapping.column) {
          console.log(`Question ${selectedQuestion} requires parameters.`);
          handleParameterizedQuestion(questionText, selectedQuestion);
        } else {
          console.log(
            `Processing question ${selectedQuestion} without parameters.`
          );
          lastUserQuery = {
            type: "faq_no_param",
            data: { key: selectedQuestion },
          }; // Store for retry
          handleFetch(
            "/process_question",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ question: selectedQuestion }),
            },
            "Analyzing data..."
          );
        }
      }

      function sendCustomQuestion() {
        const questionText = uiElements.searchBox().value.trim();
        if (!questionText) {
          showError("Please enter a question to ask the AI.");
          uiElements.searchBox().focus();
          return;
        }

        hideError();
        // Deselect any selected FAQ
        selectedQuestion = "";
        document
          .querySelectorAll("#questionList li ul li div")
          .forEach((item) => {
            item.classList.remove(
              "bg-primary-600",
              "text-white",
              "font-semibold"
            );
            item.classList.add("hover:bg-gray-700");
          });

        lastUserQuery = { type: "custom_ai", data: { question: questionText } }; // Store for retry
        handleFetch(
          "/sendCustomQuestion",
          {
            // Changed endpoint to match backend example
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question: questionText }),
          },
          "Asking AI assistant..."
        );
      }

      // --- Display Results ---
      function displayResults(resultData) {
        console.log(
          "displayResults: Raw data received:",
          JSON.stringify(resultData, null, 2).substring(0, 500) + "..."
        ); // Log snippet

        hideAllMainContent(); // Hides welcome, previous results, params, popup

        const resultsContainer = uiElements.resultsContainer();
        if (!resultsContainer) {
          console.error(
            "displayResults: resultsContainer DOM element not found!"
          );
          return;
        }
        resultsContainer.classList.remove("hidden");
        console.log("displayResults: resultsContainer is now visible.");

        // --- UI Element References for this function ---
        const summarySection = uiElements.summarySection();
        const summaryTextElement = uiElements.summaryText();
        const summaryTextContainer = uiElements.summaryTextContainer();
        const visualizationSection = uiElements.visualizationSection();
        const analysisImageElement = uiElements.analysisImage(); // Ensure this ID matches your <img> tag
        const noAnalysisDiv = uiElements.noAnalysis(); // This is the DIV for "No analysis" text
        const noAnalysisTextElement = uiElements.noAnalysisText(); // The <p> tag inside noAnalysisDiv
        const downloadBtn = uiElements.downloadReportBtn();

        // --- 1. Extract Summary Text ---
        let extractedSummaryText = "";
        if (
          resultData.result &&
          resultData.result.summary &&
          typeof resultData.result.summary.text === "string"
        ) {
          extractedSummaryText = resultData.result.summary.text;
        } else if (
          resultData.summary &&
          typeof resultData.summary.text === "string"
        ) {
          extractedSummaryText = resultData.summary.text;
        }
        // No need for the complex base64 check for summary here, assuming summary is always text.
        console.log(
          "displayResults: Final extractedSummaryText:",
          extractedSummaryText
        );

        // --- 2. Display Summary ---
        if (summarySection && summaryTextElement && summaryTextContainer) {
          if (extractedSummaryText && extractedSummaryText.trim() !== "") {
            summaryTextElement.innerHTML = extractedSummaryText; // Use innerHTML for potential basic formatting
            summaryTextContainer.classList.remove(
              "border-red-500",
              "bg-red-900",
              "bg-opacity-30"
            );
            summaryTextContainer.classList.add(
              "border-gray-600",
              "bg-gray-700"
            );
            summarySection.classList.remove("hidden");
          } else {
            summaryTextElement.innerHTML = "";
            summarySection.classList.add("hidden");
          }
        } else {
          console.error(
            "displayResults: One or more summary DOM elements not found!"
          );
        }

        // --- 3. Handle Visualization ---
        let rawBase64Image = null;
        let vizMessage =
          "No visualization generated or applicable for this analysis.";

        if (
          resultData.result &&
          resultData.result.visualization &&
          typeof resultData.result.visualization.graph_url === "string" &&
          resultData.result.visualization.graph_url.trim() !== ""
        ) {
          rawBase64Image = resultData.result.visualization.graph_url.trim();
          console.log(
            "displayResults: Image data found in result.visualization.graph_url"
          );
          if (resultData.result.visualization.message)
            vizMessage = resultData.result.visualization.message;
        } else if (
          resultData.result &&
          resultData.result.analysis &&
          typeof resultData.result.analysis.result === "string"
        ) {
          const potentialImage = resultData.result.analysis.result.trim();
          if (
            potentialImage !== "" &&
            potentialImage.length > 50 &&
            /^[A-Za-z0-9+/=\s]*$/.test(potentialImage) &&
            (potentialImage.length % 4 === 0 || potentialImage.endsWith("="))
          ) {
            rawBase64Image = potentialImage;
            console.log(
              "displayResults: Image data found in result.analysis.result (assumed base64)"
            );
          }
        }
        // Add other fallbacks if necessary, like resultData.visualization.graph_url

        const hasValidGraphData = rawBase64Image && rawBase64Image.length > 50;
        console.log("displayResults: hasValidGraphData:", hasValidGraphData);

        if (
          visualizationSection &&
          analysisImageElement &&
          noAnalysisDiv &&
          noAnalysisTextElement &&
          downloadBtn
        ) {
          visualizationSection.classList.remove("hidden"); // Always show the visualization section header

          if (hasValidGraphData) {
            analysisImageElement.src =
              "data:image/png;base64," + rawBase64Image;
            analysisImageElement.style.display = "block"; // Show the image
            noAnalysisDiv.style.display = "none"; // Hide the "no analysis" message
            downloadBtn.disabled = false;
            downloadBtn.classList.remove("opacity-50", "cursor-not-allowed");
            console.log("displayResults: Visualization image displayed.");
          } else {
            analysisImageElement.src = "";
            analysisImageElement.style.display = "none"; // Hide the image element
            noAnalysisTextElement.textContent = vizMessage;
            noAnalysisDiv.style.display = "flex"; // Show the "no analysis" message
            downloadBtn.disabled = true;
            downloadBtn.classList.add("opacity-50", "cursor-not-allowed");
            console.log(
              "displayResults: 'No analysis' message displayed:",
              vizMessage
            );
          }
        } else {
          console.error(
            "displayResults: One or more visualization DOM elements not found!"
          );
          if (!visualizationSection) console.error("Viz Section missing");
          if (!analysisImageElement) console.error("Analysis Image missing");
          if (!noAnalysisDiv) console.error("No Analysis Div missing");
          if (!noAnalysisTextElement) console.error("No Analysis Text missing");
          if (!downloadBtn) console.error("Download Button missing");
        }

        // --- 4. Handle Overall Empty Results ---
        const isSummaryEmpty =
          !extractedSummaryText || extractedSummaryText.trim() === "";
        const isVisualizationEffectivelyHidden = !hasValidGraphData;

        if (isSummaryEmpty && isVisualizationEffectivelyHidden) {
          console.log(
            "displayResults: Both summary and visualization are effectively empty."
          );
        }

        resultsContainer.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      // --- Utility ---
      function resetQuestionDisplay() {
        // Clear search highlights and restore original text
        document.querySelectorAll("#questionList li ul li").forEach((item) => {
          const spanElement = item.querySelector("div > span");
          if (spanElement && item.dataset.originalText) {
            spanElement.innerHTML = item.dataset.originalText;
            delete item.dataset.originalText;
          }
          item
            .querySelector("div")
            .classList.remove("bg-yellow-800", "bg-opacity-25");
          item.style.display = "";
        });
        uiElements.searchStatus()?.classList.add("hidden");
        // Collapse categories unless one inside is still selected (unlikely after reset, but safe)
        document
          .querySelectorAll("#questionList > li")
          .forEach((categoryItem) => {
            const categoryList = categoryItem.querySelector("ul");
            if (!categoryList) return;
            const isAnySelected =
              categoryList.querySelector("div.bg-primary-600") !== null;
            if (!isAnySelected) {
              categoryList.classList.add("hidden");
              const chevron = categoryItem.querySelector(".category-chevron");
              if (chevron) chevron.classList.remove("rotate-180");
            }
          });
      }

      // NOTE: retryLastQuery function is commented out in the HTML as it requires storing the last query details.
      function retryLastQuery() {
        console.log("Attempting to retry:", lastUserQuery);
        hideRetryPopup(); // Hide the popup first
        if (!lastUserQuery.type) {
          showError("Cannot retry: No previous query information found.");
          resetUI();
          return;
        }
        // Based on the type, re-trigger the correct function
        if (lastUserQuery.type === "faq") {
          selectedQuestion = lastUserQuery.data.key;
          processQuestion();
        } else if (lastUserQuery.type === "faq_param") {
          processQuestionWithParams(
            lastUserQuery.data.key,
            lastUserQuery.data.params,
            lastUserQuery.data.sheetIndex
          );
        } else if (lastUserQuery.type === "custom_ai") {
          // Need to put the question back in the search box? Or just resend?
          // uiElements.searchBox().value = lastUserQuery.data.question; // Optional
          sendCustomQuestion(); // This will read from the box again, so maybe better to resend directly if needed
          handleFetch(
            "/sendCustomQuestion",
            {
              // Example direct resend
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ question: lastUserQuery.data.question }),
            },
            "Retrying AI assistant..."
          );
        } else {
          showError("Cannot retry: Unknown query type.");
          resetUI();
        }
      }
    </script>
  </body>
</html>
